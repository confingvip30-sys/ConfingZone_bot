import sqlite3
import random
from datetime import datetime
from fastapi import FastAPI, Request
import uvicorn

# ==============================
# ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø±Ø¨Ø§Øª
# ==============================
TOKEN = "CFIHB0MENZZGSVPCDZYDUMQFKBJYLOPSKHCGFLMEDDOFMFVCYUOSMPKUAGRFSZCU"
ADMIN_USERNAME = "@Confiiing_VIP"  # Ø¢ÛŒØ¯ÛŒ Ø§Ø¯Ù…ÛŒÙ† Ø±ÙˆØ¨ÛŒÚ©Ø§

# Ø¯ÛŒØªØ§Ø¨ÛŒØ³
conn = sqlite3.connect("bot.db", check_same_thread=False)
cur = conn.cursor()

cur.execute("""CREATE TABLE IF NOT EXISTS users (
    user_id TEXT PRIMARY KEY,
    join_date TEXT,
    balance INTEGER DEFAULT 0,
    purchases INTEGER DEFAULT 0,
    last_order TEXT
)""")
conn.commit()

# ==============================
# Ø³Ø±ÙˆØ± FastAPI Ø¨Ø±Ø§ÛŒ ÙˆØ¨Ù‡ÙˆÚ©
# ==============================
app = FastAPI(https://github.com/confingvip30-sys/ConfingZone_bot.git)

@app.post("/webhook")
async def webhook(request: Request):
    data = await request.json()
    user_id = str(data.get("user", {}).get("id", ""))
    text = data.get("text", "")

    if not user_id:
        return {"ok": True}

    # Ø«Ø¨Øª Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³
    cur.execute("SELECT * FROM users WHERE user_id=?", (user_id,))
    if not cur.fetchone():
        cur.execute("INSERT INTO users (user_id, join_date) VALUES (?, ?)",
                    (user_id, datetime.now().strftime("%Y-%m-%d %H:%M")))
        conn.commit()

    # Ø¯Ø³ØªÙˆØ± Ø´Ø±ÙˆØ¹
    if text == "/start":
        return {
            "ok": True,
            "result": {
                "text": "Ø¨Ù‡ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ ConfingZone Ø®ÙˆØ´ Ø§ÙˆÙ…Ø¯ÛŒ ğŸŒ¿ğŸ’\n"
                        "Ø§Ø±Ø§Ø¦Ù‡ Ø¨Ø§Ú©ÛŒÙÛŒØªâ€Œ ØªØ±ÛŒÙ† Ø³Ø±ÙˆØ±Ù‡Ø§ ğŸ‘‘\n"
                        "Ø«Ø§Ø¨Øªâ€ŒØªØ±ÛŒÙ† IP Ø¨Ø¯ÙˆÙ† Ú©ÙˆÚ†Ú©ØªØ±ÛŒÙ† ØªØºÛŒÛŒØ± ğŸ«§\n\n"
                        "Ø¨Ø±Ø§ÛŒ ØªÙ‡ÛŒÙ‡ Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ Ø§Ø² Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ğŸ‘‡",
                "keyboard": [
                    ["/shop", "/myconfigs"],
                    ["/buy", "/learn"],
                    ["/lottery", "/contact"],
                    ["/account"]
                ]
            }
        }

    # ÙØ±ÙˆØ´Ú¯Ø§Ù‡
    elif text == "/shop":
        return {
            "ok": True,
            "result": {
                "text": "Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:",
                "keyboard": [
                    ["Ú©Ø§Ù†ÙÛŒÚ¯ Ù‡Ø§ÛŒ Ø§Ù‚ØªØµØ§Ø¯ÛŒ â˜˜ï¸ğŸ©µ"],
                    ["Ú©Ø§Ù†ÙÛŒÚ¯ Ù‡Ø§ÛŒ Ø¨Ù…Ø¨ Ùˆ VIP ğŸ‘¾ğŸ‘½"]
                ]
            }
        }

    # Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ
    elif text == "/contact":
        return {
            "ok": True,
            "result": {
                "text": f"Ø¨Ø±Ø§ÛŒ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø¨Ù‡ Ø§ÛŒÙ† Ø¢ÛŒØ¯ÛŒ Ù¾ÛŒØ§Ù… Ø¨Ø¯Ù‡:\n{ADMIN_USERNAME}"
            }
        }

    # Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ
    elif text == "/account":
        cur.execute("SELECT * FROM users WHERE user_id=?", (user_id,))
        u = cur.fetchone()
        purchases = u[3]
        role = "Ú©Ø§Ø±Ø¨Ø± Ø¹Ø§Ø¯ÛŒ"
        if 5 <= purchases < 15:
            role = "Ú©Ø§Ø±Ø¨Ø± ÙØ¹Ø§Ù„"
        elif purchases >= 15:
            role = "Ù…Ø´ØªØ±ÛŒ Ù‡Ù…ÛŒØ´Ú¯ÛŒ"

        return {
            "ok": True,
            "result": {
                "text": f"ğŸ‘¤ Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø±ÛŒ: {user_id}\n"
                        f"ğŸ—ï¸ Ù†Ù‚Ø´ Ù…Ù†: {role}\n"
                        f"ğŸ•‘ ØªØ§Ø±ÛŒØ® Ø¹Ø¶ÙˆÛŒØª: {u[1]}\n"
                        f"ğŸ‘ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù…Ù†: {u[2]} ØªÙˆÙ…Ø§Ù†\n"
                        f"ğŸŒ€ Ø¢Ø®Ø±ÛŒÙ† Ø³ÙØ§Ø±Ø´: {u[4]}\n"
                        f"ğŸ—³ï¸ ØªØ¹Ø¯Ø§Ø¯ Ø³ÙØ§Ø±Ø´ Ù…ÙˆÙÙ‚: {u[3]}"
            }
        }

    else:
        return {"ok": True, "result": {"text": "Ø¯Ø³ØªÙˆØ± Ù†Ø§Ù…Ø¹ØªØ¨Ø± âš ï¸"}}

# Ø§Ø¬Ø±Ø§ÛŒ Ù„ÙˆÚ©Ø§Ù„ (Ø¨Ø±Ø§ÛŒ ØªØ³Øª)
if __name__ == "__main__":
    uvicorn.run(app, host="0.0.0.0", port=8000)
if __name__ == "__main__":
    port = int(os.environ.get("PORT", 5000))
    app.run(host="0.0.0.0", port=port)
